{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'styles/style.css' %}">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nexus</title>
    <link rel="shortcut icon" href="/static/images/favicon.ico" type="image/ico">
</head>
<!--<body style="background-image: url({% static "images/background.jpg" %});">-->
<body class="c_body">
<div class="block control-1">
    <div id = "btn-lstrafe" class="control-button">&#8592;</div>
    <div id = "btn-forward" class="control-button">&#8593;</div>
    <div id = "btn-rstrafe" class="control-button">&#8594;</div>
    <div id = "btn-lturn" class="control-button">&#8630;</div>
    <div id = "btn-backward" class="control-button">&#8595;</div>
    <div id = "btn-rturn" class="control-button">&#8631;</div>
</div>
<div class="block control-2">
    <div id = "btn-lforw" class="control-button">&#8598;</div>
    <div id = "btn-rforw" class="control-button">&#8599;</div>
    <div id = "btn-lbackw" class="control-button">&#8601;</div>
    <div id = "btn-rbackw" class="control-button">&#8600;</div>
</div>
<div class="block activation-speed">
    <div id = "btn-activate" class="control-button button-text">Act (Y)</div>
    <div id = "btn-deactivate" class="control-button button-text">DeAct (U)</div>
    <div id = "btn-exit" class="control-button button-text">Exit (I)</div>
    <div id = "btn-minus-speed" class="control-button">-</div>
    <div id = "div-speed" class="control-button"></div>
    <div id = "btn-plus-speed" class="control-button">+</div>
</div>
<div class="block supply">
    <div class="simple-div">
        <div style="vertical-align: middle;display: inline-block;"><img class="image-battery" src="/static/images/battery_image.png"></div>
    <div style="vertical-align: middle;clear: none;display: inline-block;margin: 0px 5px;width: 40px;">PI</div>
        <div style="display: inline-block;">4.2V / 100%</div>
    </div>
    <div class="simple-div">
        <div style="vertical-align: middle;display: inline-block;"><img class="image-battery" src="/static/images/battery_image.png"></div>
    <div style="vertical-align: middle;clear: none;display: inline-block;margin: 0px 5px;width: 40px;">Servo</div>
        <div style="display: inline-block;">8.0V / 93%</div>
    </div>
</div>
<div class="block gyroaccel">
    <div class="gyro-middle-block">
        <div class="gyro-inner-block">X</div>
        <div class="gyro-inner-block">90</div>
    </div>
    <div class="gyro-middle-block">
        <div class="gyro-inner-block">Y</div>
        <div class="gyro-inner-block">70</div>
    </div>
    <div class="gyro-middle-block">
        <div class="gyro-inner-block">Z</div>
        <div class="gyro-inner-block">30</div>
    </div>
</div>


<div class="div-image-holder"><img class="image-src" src="/static/images/img.jpg" alt="Video" id="myImage"/></div>
</body>

<script>
var myImageElement = document.getElementById('myImage');

//setInterval(function() {    
//    myImageElement.src = '/static/images/img.jpg?' + Math.random();
//}, 350);

function getMillis() {
    var dttm = new Date();
    return dttm.getSeconds()*1000 + dttm.getMilliseconds();
}
var last_request_dttm = getMillis();
var last_request = '';

var speed = 0;
function writeSpeed(speed) {
    document.getElementById('div-speed').innerHTML = speed;
}

fetch('/get_speed')
    .then(response => response.json())
    .then(data => {
        speed = parseInt(data['speed'], 10);
        writeSpeed(speed);
    })
    .catch(err => {
        console.error('An error ocurred', err);
    });


var getJSON = function (url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function () {
        var status = xhr.status;
        if (status == 200) {
            callback(null, xhr.response);
        } else {
            callback(status);
        }
    };
    xhr.send();
};


class LoadersManager {
    constructor() {
        this.queue = [];
        this.running_task = undefined;
    }

    load(loader) {
        //disableButtons();
        lm.running_task = loader;

        getJSON(loader.api,
                function (err, data) {
                    if (err != null) {
                        AlertError.render('API ERROR', "Error loading data. Contact administrator. Api: " + api);
                        console.log('Error : ' + err);
                    } else {
                        loader.data = data;
                        var index = lm.queue.indexOf(loader);

                        if (index > -1) {
                            lm.queue.splice(index, 1);
                        }

                        if (loader.result_function != undefined) {
                            if (loader.function_options != undefined) {
                                loader.result_function(data, loader.function_options);
                            } else {
                                loader.result_function(data);
                            }

                        }

                        lm.running_task = undefined;
                        lm.run_next_loader();
                    }
                });
    }

    add_to_queue(loader) {
        if (this.running_task == undefined) {
            this.load(loader);
        } else {
            this.queue.push(loader);
        }
    }

    run_next_loader() {
        //console.log('Queue length : ' + this.queue.length);

        if (this.queue.length > 0){
            this.load(this.queue[0]);
        } else {
            //enableButtons();
        }
    }
}

lm = new LoadersManager();

class Loader {
    constructor(api, result_function=undefined, function_options=undefined) {
        this.is_done = 0;
        this.api = api;
        this.result_function = result_function;
        this.function_options = function_options;

        if (api == last_request && getMillis() - last_request_dttm < 700) {
            // that is anti-spam, ignoring same commands
            delete this;
        } else {
            last_request_dttm = getMillis();
            last_request = api;
            lm.add_to_queue(this);
        }
    }
}

document.onkeydown = function(event) {

    if (event.keyCode < 32) return null; // спец. символ
    var ch = event.keyCode;
    var command = 'None';

    if (ch == "Q".charCodeAt(0)) {
        document.getElementById("btn-lstrafe").classList.add("pressed");
        command = 'StrafeLeft';
    }
    else if (ch == "W".charCodeAt(0)) {
        document.getElementById("btn-forward").classList.add("pressed");
        command = 'Forward';
    }
    else if (ch == "E".charCodeAt(0)) {
        document.getElementById("btn-rstrafe").classList.add("pressed");
        command = 'StrafeRight';
    }
    else if (ch == "A".charCodeAt(0)) {
        document.getElementById("btn-lturn").classList.add("pressed");
        command = 'TurnLeft';
    }
    else if (ch == "S".charCodeAt(0)) {
        document.getElementById("btn-backward").classList.add("pressed");
        command = 'Back';
    }
    else if (ch == "D".charCodeAt(0)) {
        document.getElementById("btn-rturn").classList.add("pressed");
        command = 'TurnRight';
    }
    else if (ch == "R".charCodeAt(0)) {
        document.getElementById("btn-lforw").classList.add("pressed");
        command = 'LeftForward';
    }
    else if (ch == "T".charCodeAt(0)) {
        document.getElementById("btn-rforw").classList.add("pressed");
        command = 'RightForward';
    }
    else if (ch == "F".charCodeAt(0)) {
        document.getElementById("btn-lbackw").classList.add("pressed");
        command = 'LeftBackwards';
    }
    else if (ch == "G".charCodeAt(0)) {
        document.getElementById("btn-rbackw").classList.add("pressed");
        command = 'RightBackwards';
    }
    else if (ch == "Y".charCodeAt(0)) {
        document.getElementById("btn-activate").classList.add("pressed");
        command = 'Activate';
    }
    else if (ch == "U".charCodeAt(0)) {
        document.getElementById("btn-deactivate").classList.add("pressed");
        command = 'Deactivate';
    }
    else if (ch == "I".charCodeAt(0)) {
        document.getElementById("btn-exit").classList.add("pressed");
        command = 'Exit';
    }

    else if (ch == 107) { // + sign
        document.getElementById("btn-plus-speed").classList.add("pressed");
        if (speed < 100) {
            speed += 1;
        }
        api = '/set_speed?speed=' + speed;
        new Loader(api);
        writeSpeed(speed);
    }
    else if (ch == 109) { // - sign
        document.getElementById("btn-minus-speed").classList.add("pressed");
        if (speed > 90) {
            speed -= 1;
        }
        api = '/set_speed?speed=' + speed;
        new Loader(api);
        writeSpeed(speed);
    }

    if (command!= 'None'){        
        api = '/command?com=' + command;
        new Loader(api);
    }

};

document.onkeyup = function (event) {

    document.getElementById("btn-lstrafe").classList.remove("pressed");
    document.getElementById("btn-backward").classList.remove("pressed");
    document.getElementById("btn-rstrafe").classList.remove("pressed");
    document.getElementById("btn-lturn").classList.remove("pressed");
    document.getElementById("btn-forward").classList.remove("pressed");
    document.getElementById("btn-rturn").classList.remove("pressed");
    document.getElementById("btn-lforw").classList.remove("pressed");
    document.getElementById("btn-rforw").classList.remove("pressed");
    document.getElementById("btn-lbackw").classList.remove("pressed");
    document.getElementById("btn-rbackw").classList.remove("pressed");
    document.getElementById("btn-activate").classList.remove("pressed");
    document.getElementById("btn-deactivate").classList.remove("pressed");
    document.getElementById("btn-exit").classList.remove("pressed");
    document.getElementById("btn-plus-speed").classList.remove("pressed");
    document.getElementById("btn-minus-speed").classList.remove("pressed");
}

</script>